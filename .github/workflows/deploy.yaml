name: "Production Infrastructure Pipeline"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  # ---------------------------------------------------------
  # JOB 1: Security & Compliance (Shift-Left)
  # Runs static analysis before touching any infrastructure
  # ---------------------------------------------------------
  security-audit:
    name: "DevSecOps Audit"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Security: Scans Terraform for misconfigurations (e.g., public buckets, no encryption)
      - name: Run Checkov Security Scan
        uses: bridgecrewio/checkov-action@master
        with:
          directory: terraform/
          soft_fail: true # Set to false to block build on security issues
          quiet: true     # Only display errors

  # ---------------------------------------------------------
  # JOB 2: Infrastructure Validation (Ephemeral Environment)
  # Spins up a temporary K8s cluster to validate the Terraform logic
  # ---------------------------------------------------------
  terraform-validation:
    name: "Terraform Plan & Validate"
    needs: security-audit # Only runs if security passes
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./terraform/environments/prod

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      # Tooling: Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2

      # Testing: Create a disposable Kubernetes cluster inside the runner
      # This allows Terraform to actually connect to a cluster and validate resources
      - name: Create Ephemeral Kind Cluster
        uses: helm/kind-action@v1.4.0
        with:
          cluster_name: ci-test-cluster

      # Terraform Workflow
      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      # Planning: Shows what would happen (Dry Run)
      - name: Terraform Plan
        run: terraform plan -input=false -lock=false
        env:
          # In a real scenario, credentials would be GitHub Secrets
          KUBE_CONFIG_PATH: ~/.kube/config